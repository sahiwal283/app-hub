# Nginx Configuration Snippet for Core Platform
# 
# IMPORTANT: This is a snippet that must be manually merged into your existing Nginx configuration.
# DO NOT replace your entire Nginx config with this file.
#
# This snippet assumes:
# - Nginx is running in a separate container
# - Platform frontend/backend are accessible at http://192.168.1.20:3000 and http://192.168.1.20:4000
# - Zoho service is accessible at http://192.168.1.50:8000 (adjust as needed)
# - SSL certificates are configured separately
#
# Adjust IP addresses and ports to match your actual setup.

# Upstream definitions
upstream platform_frontend {
    server 192.168.1.20:3000;
    keepalive 32;
}

upstream platform_backend {
    server 192.168.1.20:4000;
    keepalive 32;
}

upstream zoho_service {
    server 192.168.1.50:8000;  # Adjust to your Zoho service IP/port
    keepalive 32;
}

# Next.js hashed static assets
# Serve with long immutable cache; filenames change on each build.
location ^~ /_next/static/ {
    proxy_pass http://platform_frontend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
}

# Platform frontend (root path)
location / {
    proxy_pass http://platform_frontend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_hide_header Cache-Control;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Platform backend API
location /api {
    proxy_pass http://platform_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_buffering off;
}

# Version metadata should update immediately after deploy.
location = /api/meta/version {
    proxy_pass http://platform_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_hide_header Cache-Control;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Zoho shared service
location /services/zoho {
    proxy_pass http://zoho_service;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_buffering off;
    
    # Optional: Forward platform JWT if Zoho service expects it
    # proxy_set_header Authorization $http_authorization;
}

# Internal apps routing
# Example: Trade Show app (internal)
location /apps/trade-show {
    proxy_pass http://192.168.1.25:8000;  # Adjust to your internal app backend
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    
    # Forward cookies for JWT authentication
    proxy_cookie_path / /apps/trade-show;
}

# Example: Tablets app (internal)
location /apps/tablets {
    proxy_pass http://192.168.1.26:8000;  # Adjust to your internal app backend
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    
    # Forward cookies for JWT authentication
    proxy_cookie_path / /apps/tablets;
}

# External apps routing (proxied to external URLs)
# Example: Expenses app (external, proxied to PythonAnywhere or SaaS)
location /apps/expenses {
    proxy_pass https://example.com/expenses;  # Replace with actual external URL
    proxy_http_version 1.1;
    proxy_set_header Host example.com;  # Set to external hostname
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_ssl_server_name on;
    
    # Note: Some external apps may require path rewriting if they expect root path
    # Uncomment and adjust if needed:
    # rewrite ^/apps/expenses/(.*)$ /$1 break;
}

# Generic app routing pattern (catch-all for dynamic app slugs)
# WARNING: This is a generic pattern. For production, define explicit routes per app
# or use a more sophisticated routing solution.
#
# Uncomment and adjust if you want a catch-all:
# location ~ ^/apps/([^/]+)(/.*)?$ {
#     set $app_slug $1;
#     # You may need to use a map directive or lua script to route dynamically
#     # For now, explicit routes per app are recommended
# }

# Health check endpoint (optional, for monitoring)
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# Notes:
# 1. For SSL/HTTPS, wrap these locations in a server block with ssl_certificate directives
# 2. Adjust IP addresses (192.168.1.20, 192.168.1.50, etc.) to match your actual container IPs
# 3. For external apps that require root path, you may need path rewriting
# 4. Internal apps should validate JWT from cookies - ensure cookies are forwarded
# 5. Consider adding rate limiting, caching, and security headers as needed
